##
## MANAGED BY PUPPET - Do NOT edit this file!
##

groups:
- name: example-node-exporter-rules
  rules:
  # The count of CPUs per node, useful for getting CPU time as a percent of total.
  - record: instance:node_cpus:count
    expr: count(node_cpu_seconds_total{mode="idle"}) without (cpu,mode)

  # CPU in use by CPU.
  - record: instance_cpu:node_cpu_seconds_not_idle:rate5m
    expr: sum(rate(node_cpu_seconds_total{mode!="idle"}[5m])) without (mode)

  # CPU in use by mode.
  - record: instance_mode:node_cpu_seconds:rate5m
    expr: sum(rate(node_cpu_seconds_total[5m])) without (cpu)

  # CPU in use ratio.
  - record: instance:node_cpu_utilization:ratio
    expr: sum(instance_mode:node_cpu_seconds:rate5m{mode!="idle"}) without (mode) / instance:node_cpus:count

- name: Instance Status
  rules:
  - alert: InstanceDown
    expr: up == 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: Haaaalp, I've fallen and I can't get up (Instance Down for 5m or more)

- name: SystemD High CPU Usage
  rules:
  - alert: cpuUsage (SystemD)
    expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{job='node_exporter',mode="idle"}[5m])) * 100) > 95
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: Machine under heavy load, the world is kind of sorta burning down (CPU above 95% for 5m or more)

- name: Init High CPU Usage
  rules:
  - alert: cpuUsage (INIT)
    expr: 100 - (avg by (instance) (irate(node_cpu_seconds_total{job='init_node_exporter',mode="idle"}[5m])) * 100) > 95
    for: 5m
    labels:
      severity: critical
    annotations:
      summary: Machine under heavy load, the world is kind of sorta burning down (CPU above 95% for 5m or more)

- name: host-alerts
  rules:
  - alert: LowMemory
    expr: ((node_memory_MemFree{instance=~"$server"} / node_memory_MemTotal{instance=~"$server"})
      * 100) < 5
    for: 5m
    labels:
      severity: warning
    annotations:
      text: '{{ $labels.instance }} of job {{ $labels.job }} has had low available
        memeory for than 5 minutes.'
  - alert: cpu_threshold_exceeded
    expr: (100 * (1 - avg by(Name) (irate(node_cpu{job="node",mode="idle"}[5m]))))
      > 90
    for: 1m
    annotations:
      description: This device's CPU usage has exceeded the threshold with a value
        of {{ $value }}.
      summary: Instance {{ $labels.instance }} CPU usage is dangerously high
  - alert: low_disk_space
    expr: (node_filesystem_free / node_filesystem_size) * 100 < 10
    for: 5m
    annotations:
      description: This device has a disk with less than 10% free {{ $value }}.
      summary: Instance {{ $labels.instance }} Disk free space is below 10%
  - alert: TooManyOpenFileDescriptors
    expr: 100 * (process_open_fds / process_max_fds) > 95
    for: 10m
    labels:
      severity: critical
    annotations:
      description: '{{ $labels.job }}: {{ $labels.namespace }}/{{ $labels.pod }} ({{
        $labels.instance }}) is using {{ $value }}% of the available file/socket descriptors.'
      summary: too many open file descriptors
  - alert: FdExhaustionClose
    expr: predict_linear(instance:fd_utilization[1h], 3600 * 4) > 1
    for: 10m
    labels:
      severity: warning
    annotations:
      description: '{{ $labels.job }}: {{ $labels.namespace }}/{{ $labels.pod }} ({{
        $labels.instance }}) instance will exhaust in file/socket descriptors soon'
      summary: file descriptors soon exhausted
  - alert: FdExhaustionClose
    expr: predict_linear(instance:fd_utilization[10m], 3600) > 1
    for: 10m
    labels:
      severity: critical
    annotations:
      description: '{{ $labels.job }}: {{ $labels.namespace }}/{{ $labels.pod }} ({{
        $labels.instance }}) instance will exhaust in file/socket descriptors soon'
      summary: file descriptors soon exhausted
